<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MCA-OMAD – Guia Diário (Fase III) · PWA v1.5</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f3b66">
<style>
  :root{
    --bg:#ffffff; --text:#111418; --muted:#6b7280; --card:#f7f8fa; --line:#e5e7eb;
    --blue:#CFE4F7; --green:#E5F4E3; --peach:#FFEFD6; --steel:#E8ECF2; --lilac:#F1ECF9; --gold:#FFF5CC;
    --accent:#0f3b66; --off:#f2f3f5; --highlight:#e0f2fe; --good:#16a34a; --warn:#d97706; --bad:#dc2626;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;background:linear-gradient(180deg,#ffffff 60%, #fafbfc 100%);border-bottom:1px solid var(--line);padding:12px;z-index:10; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
  header h1{font-size:18px;margin:0;color:var(--accent);}
  header p{margin:2px 0 0 0;font-size:12px;color:#6b7280}
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .btn{white-space:nowrap; font-size:13px; padding:8px 12px; border-radius:10px; border:1px solid #cbd5e1; background:#ffffff; color:#0f3b66; cursor:pointer}
  .btn:hover{background:#f3f4f6}
  .chip{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #cbd5e1; background:#ffffff; color:#0f3b66; }
  .week-btn.active, .mode-btn.active{background:#0f3b66; color:#fff; border-color:#0f3b66}
  .wrap{padding:14px;max-width:980px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;margin:12px 0;overflow:hidden}
  .band{padding:10px 12px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
  .band small{font-weight:600;color:#374151}
  .inner{padding:10px 12px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 6px;font-size:14px;text-align:center;border-bottom:1px solid #edf0f3}
  th{font-size:13px;color:#111418;background:#fff}
  td:first-child, th:first-child{text-align:left}
  .obs{font-size:12px;color:#374151;text-align:left}
  .meta-dia{font-size:12px;font-style:italic;color:#374151;margin:6px 2px 2px}
  .foot{margin:20px 0 80px;color:#374151;font-size:12px;text-align:center}
  .pill{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #d1d5db;background:#fff;color:#111418}
  .manha .band{background:var(--blue)}
  .omad .band{background:var(--green)}
  .pre .band{background:var(--peach)}
  .pos .band{background:var(--steel)}
  .noite .band{background:var(--lilac)}
  .avancado .band{background:var(--gold)}
  input[type=checkbox]{width:18px;height:18px}
  .off{background:var(--off); color:#9aa1a9}
  .today{background:var(--highlight) !important}
  .hidden{display:none !important}
  .carousel{display:flex; gap:6px; align-items:center}
  .carousel .btn{padding:6px 10px}
  @media print{ .toolbar{display:none !important} header{position:static} }
</style>
</head>
<body>
<header>
  <div>
    <h1>MCA-OMAD – Guia Diário (Fase III) · PWA v1.5</h1>
    <p>Período-alvo: 19/10 → 08/11/2025 · <span id="dateLabel">—</span></p>
  </div>
</header>

<div class="wrap">
  <p>✅ Interface carregada com sucesso.</p>
  <p>Após commit, recarregue com <b>Cmd + Shift + R</b> (Safari/Chrome no Mac) ou <b>Ctrl + Shift + R</b> (Windows).</p>
</div>

<!-- SDK do Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // === CONFIGURAÇÃO DO SUPABASE ===
  const SUPABASE_URL = "https://srmavbuaarejrqlibyha.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNybWF2YnVhYXJlanJxbGlieWhhIiwicm9zZSI6ImFub24iLCJpYXQiOjE3NjA4NzUzNjIsImV4cCI6MjA3NjQ1MTM2Mn0.LpKRrGABJWE3cgnQI5eShlYlKwyS_NUp1To7FPhJ1sQ";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const PROFILE_ID = "marcio";
  const STORE_KEY = "mca_omad_v15";

  function isoToday() {
    const d = new Date(); d.setHours(0,0,0,0);
    return d.toISOString().slice(0,10);
  }

  function collectState(){
    const raw = localStorage.getItem(STORE_KEY);
    const payload = raw ? JSON.parse(raw) : {};
    return { [STORE_KEY]: payload };
  }

  function applyState(stateObj){
    if (stateObj && stateObj[STORE_KEY] !== undefined){
      localStorage.setItem(STORE_KEY, JSON.stringify(stateObj[STORE_KEY]));
      location.reload();
    } else {
      alert('Nenhum dado válido para restaurar');
    }
  }

  async function syncUp(){
    const day = isoToday();
    const state = collectState();
    const { error } = await sb.from("daily_state")
      .upsert({ profile_id: PROFILE_ID, day, state, updated_at: new Date().toISOString() });
    alert(error ? ("❌ Falha ao salvar: " + error.message) : ("✅ Salvo na nuvem: " + day));
  }

  async function syncDown(){
    const day = isoToday();
    const { data, error } = await sb.from("daily_state")
      .select("state").eq("profile_id", PROFILE_ID).eq("day", day).maybeSingle();
    if (error) return alert("❌ Falha ao carregar: " + error.message);
    if (!data) return alert("⚠️ Nenhum dado encontrado para " + day);
    applyState(data.state);
  }

  // === BOTÕES VISUAIS ===
  (function addButtons(){
    const bar = document.createElement("div");
    Object.assign(bar.style,{
      position:"fixed",top:"10px",right:"10px",zIndex:"9999",
      display:"flex",gap:"8px"
    });

    const b1=document.createElement("button");
    b1.textContent="Sync ↑"; b1.title="Salvar na nuvem";
    Object.assign(b1.style,{padding:"6px 10px",borderRadius:"8px",border:"1px solid #ccc",background:"#f0f9ff"});
    b1.onclick=syncUp;

    const b2=document.createElement("button");
    b2.textContent="Sync ↓"; b2.title="Baixar da nuvem";
    Object.assign(b2.style,{padding:"6px 10px",borderRadius:"8px",border:"1px solid #ccc",background:"#f6ffed"});
    b2.onclick=syncDown;

    bar.append(b1,b2); document.body.append(bar);

    // Verifica conexão Supabase
    sb.from("daily_state").select("id").limit(1)
      .then(res => {
        if (!res.error) {
          console.log("✅ Supabase conectado com sucesso");
        } else {
          console.warn("⚠️ Erro ao conectar Supabase:", res.error.message);
        }
      });
  })();
</script>
</body>
</html>

<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MCA-OMAD ‚Äì Guia Di√°rio (Fase III) ¬∑ v1.6</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f3b66">
<style>
  :root{
    --bg:#ffffff; --text:#111418; --muted:#6b7280; --card:#f7f8fa; --line:#e5e7eb;
    --blue:#CFE4F7; --green:#E5F4E3; --peach:#FFEFD6; --steel:#E8ECF2; --lilac:#F1ECF9; --gold:#FFF5CC;
    --accent:#0f3b66; --off:#f2f3f5; --highlight:#e0f2fe; --good:#16a34a; --warn:#d97706; --bad:#dc2626;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;background:linear-gradient(180deg,#ffffff 60%, #fafbfc 100%);border-bottom:1px solid var(--line);padding:12px;z-index:10; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
  header h1{font-size:18px;margin:0;color:var(--accent);}
  header p{margin:2px 0 0 0;font-size:12px;color:#6b7280}
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .btn{white-space:nowrap; font-size:13px; padding:8px 12px; border-radius:10px; border:1px solid #cbd5e1; background:#ffffff; color:#0f3b66; cursor:pointer}
  .btn:hover{background:#f3f4f6}
  .chip{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #cbd5e1; background:#ffffff; color:#0f3b66; }
  .week-btn.active, .mode-btn.active{background:#0f3b66; color:#fff; border-color:#0f3b66}
  .wrap{padding:14px;max-width:980px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;margin:12px 0;overflow:hidden}
  .band{padding:10px 12px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
  .band small{font-weight:600;color:#374151}
  .inner{padding:10px 12px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 6px;font-size:14px;text-align:center;border-bottom:1px solid #edf0f3}
  th{font-size:13px;color:#111418;background:#fff}
  td:first-child, th:first-child{text-align:left}
  .obs{font-size:12px;color:#374151;text-align:left}
  .meta-dia{font-size:12px;font-style:italic;color:#374151;margin:6px 2px 2px}
  .foot{margin:20px 0 80px;color:#374151;font-size:12px;text-align:center}
  .pill{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #d1d5db;background:#fff;color:#111418}
  .manha .band{background:var(--blue)}
  .omad .band{background:var(--green)}
  .pre .band{background:var(--peach)}
  .pos .band{background:var(--steel)}
  .noite .band{background:var(--lilac)}
  .avancado .band{background:var(--gold)}
  input[type=checkbox]{width:18px;height:18px}
  .off{background:var(--off); color:#9aa1a9}
  .today{background:var(--highlight) !important}
  .hidden{display:none !important}
  .carousel{display:flex; gap:6px; align-items:center}
  .carousel .btn{padding:6px 10px}
  /* Summary */
  .summary{display:flex; gap:10px; flex-wrap:wrap; align-items:center; padding:10px 12px; background:#fff; border:1px solid var(--line); border-radius:12px}
  .summary .kpi{display:flex; gap:6px; align-items:center; font-size:14px; padding:6px 10px; border-radius:10px; background:#f8fafc; border:1px solid #e5e7eb}
  .bar{height:10px; background:#e5e7eb; width:220px; border-radius:999px; overflow:hidden}
  .bar>div{height:100%}
  .g{background:var(--good)} .y{background:var(--warn)} .r{background:var(--bad)}
  .chart{display:flex; gap:8px; align-items:flex-end; height:80px; padding:8px 0}
  .chart .col{width:22px; background:#e5e7eb; border-radius:6px; position:relative; overflow:hidden}
  .chart .col>div{position:absolute; bottom:0; left:0; right:0; background:#0f3b66}
  .chart .lab{font-size:11px; color:#374151; text-align:center}
  @media print{ .toolbar{display:none !important} header{position:static} }
</style>
</head>
<body>
<header>
  <div>
    <h1>MCA-OMAD ‚Äì Guia Di√°rio (Fase III) ¬∑ v1.6</h1>
    <p>Per√≠odo: 19 de out. de 2025 ‚Üí 8 de nov. de 2025 ¬∑ Dia <span id="dnum">?</span>/21</p>
  </div>
  <div class="toolbar">
    <span class="chip" id="todayChip">Hoje: ‚Äî</span>
    <button class="btn" onclick="window.print()">üìÑ Exportar PDF</button>
    <button class="btn" id="installBtn" style="display:none">‚ûï Instalar</button>

    <button class="btn mode-btn" data-mode="semana">Vis√£o: Semana</button>
    <div class="carousel hidden" id="dayCarousel">
      <button class="btn" id="prevDay">‚óÄ</button>
      <span class="chip" id="dayLabel">‚Äî</span>
      <button class="btn" id="nextDay">‚ñ∂</button>
    </div>
    <button class="btn mode-btn" data-mode="dia">Vis√£o: Dia</button>

    <button class="btn week-btn" data-week="1">Semana 1</button>
    <button class="btn week-btn" data-week="2">Semana 2</button>
    <button class="btn week-btn" data-week="3">Semana 3</button>

    <button class="btn" id="resetBtn">‚ôª Resetar</button>
    <button class="btn" id="syncUpBtn">Sync ‚Üë</button>
    <button class="btn" id="syncDownBtn">Sync ‚Üì</button>
  </div>
</header>

<div class="wrap">

  <!-- SUMMARY -->
  <section class="summary" id="summary">
    <div class="kpi">Hoje: <strong id="sumDay">‚Äî</strong></div>
    <div class="kpi">Feitos: <strong id="doneCount">0</strong> / <span id="totalCount">0</span></div>
    <div class="kpi">
      Ades√£o hoje:
      <div class="bar"><div id="barFill" style="width:0%"></div></div>
      <strong id="pct">0%</strong>
    </div>
  </section>

  <!-- CHART -->
  <section class="card" id="chartCard">
    <div class="band">üìä Ades√£o semanal</div>
    <div class="inner">
      <div class="chart" id="chart"></div>
      <div style="display:flex; justify-content:space-between">
        <div class="lab">Dom</div><div class="lab">Seg</div><div class="lab">Ter</div><div class="lab">Qua</div><div class="lab">Qui</div><div class="lab">Sex</div><div class="lab">S√°b</div>
      </div>
    </div>
  </section>

  <!-- ====== SE√á√ïES ====== -->
  <!-- Mantenho as tabelas exatamente como voc√™ j√° tinha.
       (Manh√£ / OMAD / Pr√© / P√≥s / Noite / Avan√ßado) -->
  <!-- ===== MANH√É ===== -->
  <section class="card manha" data-section="manha">
    <div class="band">üåÖ Manh√£ <small class="meta">06:30‚Äì09:00</small></div>
    <div class="inner">
      <table>
        <thead>
          <tr>
            <th>Suplemento / Medica√ß√£o</th>
            <th class="col-th col-dom">Dom</th><th class="col-th col-seg">Seg</th><th class="col-th col-ter">Ter</th><th class="col-th col-qua">Qua</th><th class="col-th col-qui">Qui</th><th class="col-th col-sex">Sex</th><th class="col-th col-sab">S√°b</th>
            <th class="obs">Observa√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>GH (Genryzon)</td>
            <td class="col col-dom"><input type="checkbox"></td>
            <td class="off col col-seg">‚Äî</td>
            <td class="col col-ter"><input type="checkbox"></td>
            <td class="off col col-qua">‚Äî</td>
            <td class="col col-qui"><input type="checkbox"></td>
            <td class="off col col-sex">‚Äî</td>
            <td class="off col col-sab">‚Äî</td>
            <td class="obs">Dom 1,5 mg ¬∑ Ter/Qui 1,0 mg ¬∑ Aplicar ao acordar, <b>jejum absoluto</b>.</td>
          </tr>
          <tr>
            <td>Caf√© + C8</td>
            <td class="col col-dom"><input type="checkbox"></td><td class="col col-seg"><input type="checkbox"></td><td class="col col-ter"><input type="checkbox"></td>
            <td class="col col-qua"><input type="checkbox"></td><td class="col col-qui"><input type="checkbox"></td><td class="col col-sex"><input type="checkbox"></td><td class="col col-sab"><input type="checkbox"></td>
            <td class="obs">10 mL C8 no caf√© preto (manh√£). Opcional 5 mL √† tarde.</td>
          </tr>
          <tr>
            <td>Vitamina D3 + K2 (4 gotas)</td>
            <td class="col col-dom"><input type="checkbox"></td>
            <td class="off col col-seg">‚Äî</td>
            <td class="col col-ter"><input type="checkbox"></td>
            <td class="off col col-qua">‚Äî</td>
            <td class="col col-qui"><input type="checkbox"></td>
            <td class="off col col-sex">‚Äî</td>
            <td class="off col col-sab">‚Äî</td>
            <td class="obs"><b>Mesmos dias do GH</b> (Dom/Ter/Qui). Tomar <b>30‚Äì60 min</b> ap√≥s o GH, com caf√© + 10 mL C8.</td>
          </tr>
          <tr>
            <td>Liberdya (Venvanse gotas)</td>
            <td class="col col-dom"><input type="checkbox"></td><td class="col col-seg"><input type="checkbox"></td><td class="col col-ter"><input type="checkbox"></td>
            <td class="col col-qua"><input type="checkbox"></td><td class="col col-qui"><input type="checkbox"></td><td class="col col-sex"><input type="checkbox"></td><td class="col col-sab"><input type="checkbox"></td>
            <td class="obs">Dose habitual prescrita ¬∑ ap√≥s caf√© + C8.</td>
          </tr>
          <tr>
            <td>√îmega-3 (Sports Research)</td>
            <td class="off col col-dom">‚Äî</td>
            <td class="col col-seg"><input type="checkbox"></td><td class="col col-ter"><input type="checkbox"></td>
            <td class="col col-qua"><input type="checkbox"></td><td class="col col-qui"><input type="checkbox"></td><td class="col col-sex"><input type="checkbox"></td>
            <td class="col col-sab"><input type="checkbox"></td>
            <td class="obs">2 c√°psulas manh√£ <b>Seg‚ÄìSex</b>; <b>S√°bado opcional</b>. Domingo <b>off</b>.</td>
          </tr>
          <tr>
            <td>Astaxantina</td>
            <td class="off col col-dom">‚Äî</td>
            <td class="col col-seg"><input type="checkbox"></td><td class="col col-ter"><input type="checkbox"></td>
            <td class="col col-qua"><input type="checkbox"></td><td class="col col-qui"><input type="checkbox"></td><td class="col col-sex"><input type="checkbox"></td>
            <td class="off col col-sab">‚Äî</td>
            <td class="obs">12 mg manh√£ <b>Seg‚ÄìSex</b>. S√°bado e Domingo <b>off</b>.</td>
          </tr>
          <tr>
            <td>Hidrolift</td>
            <td class="col col-dom"><input type="checkbox"></td><td class="col col-seg"><input type="checkbox"></td><td class="col col-ter"><input type="checkbox"></td>
            <td class="col col-qua"><input type="checkbox"></td><td class="col col-qui"><input type="checkbox"></td><td class="col col-sex"><input type="checkbox"></td><td class="col col-sab"><input type="checkbox"></td>
            <td class="obs">250 mL manh√£ (¬Ω sach√™). +500 mL no pr√©-treino em dias de treino.</td>
          </tr>
        </tbody>
      </table>
      <div class="meta-dia">Meta: <em>Ativar metabolismo e lip√≥lise matinal mantendo foco mental e estabilidade energ√©tica.</em></div>
    </div>
  </section>

  <!-- ===== OMAD ===== -->
  <section class="card omad" data-section="omad">
    <div class="band">‚òÄÔ∏è OMAD / Almo√ßo <small class="meta">13:00</small></div>
    <div class="inner">
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th class="col-th col-dom">Dom</th><th class="col-th col-seg">Seg</th><th class="col-th col-ter">Ter</th><th class="col-th col-qua">Qua</th><th class="col-th col-qui">Qui</th><th class="col-th col-sex">Sex</th><th class="col-th col-sab">S√°b</th>
            <th class="obs">Observa√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Carnes nobres + queijo</td>
            <td class="col col-dom"><input type="checkbox"></td><td class="col col-seg"><input type="checkbox"></td><td class="col col-ter"><input type="checkbox"></td>
            <td class="col col-qua"><input type="checkbox"></td><td class="col col-qui"><input type="checkbox"></td><td class="col col-sex"><input type="checkbox"></td><td class="col col-sab"><input type="checkbox"></td>
            <td class="obs">Total 450‚Äì500 g + 80‚Äì100 g de queijo.</td>
          </tr>
          <tr>
            <td>Verduras + batatas baby</td>
            <td class="col col-dom"><input type="checkbox"></td><td class="col col-seg"><input type="checkbox"></td><td class="col col-ter"><input type="checkbox"></td>
            <td class="col col-qua"><input type="checkbox"></td><td class="col col-qui"><input type="checkbox"></td><td class="col col-sex"><input type="checkbox"></td><td class="col col-sab"><input type="checkbox"></td>
            <td class="obs">Verduras 100 g + azeite 10 mL ¬∑ 3 batatas pequenas (~80 g).</td>
          </tr>
          <tr>
            <td>CoQ10 (Ubiquinol 100 mg)</td>
            <td class="off col col-dom">‚Äî</td><td class="col col-seg"><input type="checkbox"></td><td class="col col-ter"><input type="checkbox"></td>
            <td class="col col-qua"><input type="checkbox"></td><td class="col col-qui"><input type="checkbox"></td><td class="col col-sex"><input type="checkbox"></td><td class="off col col-sab">‚Äî</td>
            <td class="obs">Tomar com refei√ß√£o <b>Seg‚ÄìSex</b>. S√°bado e Domingo <b>off</b>.</td>
          </tr>
        </tbody>
      </table>
      <div class="meta-dia">Meta: <em>Promover anabolismo limpo e saciedade com alta densidade nutricional.</em></div>
    </div>
  </section>

  <!-- ===== Pr√©, P√≥s, Noite, Avan√ßado ===== -->
  <!-- (mantidos conforme sua vers√£o; omitidos aqui por espa√ßo) -->

  <div class="foot">
    <div><strong>Metas at√© 08/11/2025:</strong> Peso ‚â§ 85 kg ¬∑ Massa magra ‚â• 36 kg ¬∑ HDL ‚â• 50 mg/dL ¬∑ T3 Livre ‚â• 3,3 pg/mL ¬∑ Sono ‚â• 7 h</div>
    <div style="margin-top:6px;color:#6b7280">Edi√ß√£o Cient√≠fica GPT-5 ‚Äì Editor Cl√≠nico Assistente de Dr. M√°rcio G. A. Cabral</div>
  </div>

</div>

<!-- ===== SCRIPTS ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ===== Config =====
const tz = 'America/Belem';
const start = new Date('2025-10-19T00:00:00');
const end   = new Date('2025-11-08T23:59:59');
const msPerDay = 86400000;
const weekdays = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
const classMap  = ['col-dom','col-seg','col-ter','col-qua','col-qui','col-sex','col-sab'];

let weeks = [
  {label:1, start:new Date('2025-10-19T00:00:00'), end:new Date('2025-10-25T23:59:59')},
  {label:2, start:new Date('2025-10-26T00:00:00'), end:new Date('2025-11-01T23:59:59')},
  {label:3, start:new Date('2025-11-02T00:00:00'), end:new Date('2025-11-08T23:59:59')},
];

// ===== localStorage =====
const STORE_KEY = 'mca_omad_v16';
function loadState(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)) || {}; }catch(e){ return {}; } }
function saveState(obj){ localStorage.setItem(STORE_KEY, JSON.stringify(obj)); }
let state = loadState(); if(!state.checks) state.checks = {}; if(!state.ui) state.ui = {};

// ===== UI state =====
const now = new Date();
let selectedDate = state.ui.selectedDate ? new Date(state.ui.selectedDate) : new Date(Math.min(Math.max(now, start), end));
let mode = state.ui.mode || 'semana';
let currentWeek = weeks.find(w => selectedDate>=w.start && selectedDate<=w.end) || weeks[0];

function persistUI(){
  state.ui = { mode, selectedDate: selectedDate.toISOString(), week: currentWeek.label };
  saveState(state);
}

// ===== Header labels =====
function refreshHeader(){
  const dnum = Math.floor((selectedDate - start)/msPerDay) + 1;
  document.getElementById('dnum').textContent = Math.min(Math.max(dnum,1),21);
  document.getElementById('todayChip').textContent = 'Hoje: ' +
    new Intl.DateTimeFormat('pt-BR', { weekday:'short', day:'2-digit', month:'2-digit' }).format(new Date());
  document.getElementById('sumDay').textContent =
    new Intl.DateTimeFormat('pt-BR', { weekday:'long', day:'2-digit', month:'2-digit' }).format(selectedDate);
}

// ===== Week headers =====
function applyWeekHeaders(){
  const fmt = new Intl.DateTimeFormat('pt-BR', { day:'2-digit', month:'2-digit' });
  const weekStart = new Date(currentWeek.start);
  document.querySelectorAll('thead tr').forEach(tr => {
    classMap.forEach((cls, i)=>{
      const th = tr.querySelector('.col-th.'+cls);
      if (th){
        const d = new Date(weekStart.getTime() + i*msPerDay);
        th.textContent = weekdays[i] + ' (' + fmt.format(d) + ')';
      }
    });
  });
}

// ===== Mode switches =====
function showOnlyDay(dateObj){
  currentWeek = weeks.find(w => dateObj>=w.start && dateObj<=w.end) || weeks[0];
  applyWeekHeaders();
  const wIdx = dateObj.getDay();
  const keep = classMap[wIdx];
  document.querySelectorAll('.col-th').forEach(th=> th.classList.add('hidden'));
  document.querySelectorAll('.'+keep+'.col-th').forEach(th=> th.classList.remove('hidden'));
  document.querySelectorAll('td.col').forEach(td=> td.classList.add('hidden'));
  document.querySelectorAll('td.'+keep).forEach(td=> td.classList.remove('hidden'));
  document.getElementById('dayLabel').textContent =
    new Intl.DateTimeFormat('pt-BR', { weekday:'long', day:'2-digit', month:'2-digit' }).format(dateObj);
  updateSummary();
}
function showAllDays(){
  document.querySelectorAll('.col-th').forEach(th=> th.classList.remove('hidden'));
  document.querySelectorAll('td.col').forEach(td=> td.classList.remove('hidden'));
  applyWeekHeaders();
  updateSummary();
}
function setMode(newMode){
  mode = newMode;
  document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.mode-btn[data-mode="${mode}"]`)?.classList.add('active');
  document.getElementById('dayCarousel').classList.toggle('hidden', mode!=='dia');
  if (mode==='dia') showOnlyDay(selectedDate); else showAllDays();
  persistUI(); refreshHeader();
}

// ===== Week buttons =====
document.querySelectorAll('.week-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.week-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const wlabel = Number(btn.dataset.week);
    currentWeek = weeks.find(w=>w.label===wlabel) || weeks[0];
    selectedDate = new Date(currentWeek.start);
    if (mode==='dia') showOnlyDay(selectedDate); else { showAllDays(); }
    persistUI(); refreshHeader(); updateChart(); window.scrollTo({top:0, behavior:'smooth'});
  });
});
document.querySelector(`.week-btn[data-week="${currentWeek.label}"]`)?.classList.add('active');

// ===== Day carousel =====
document.getElementById('prevDay').addEventListener('click', ()=>{
  selectedDate = new Date(Math.max(start, selectedDate.getTime() - msPerDay));
  showOnlyDay(selectedDate); persistUI(); refreshHeader(); updateChart();
});
document.getElementById('nextDay').addEventListener('click', ()=>{
  selectedDate = new Date(Math.min(end, selectedDate.getTime() + msPerDay));
  showOnlyDay(selectedDate); persistUI(); refreshHeader(); updateChart();
});

// ===== Persist checkboxes =====
function buildKeyForCheckbox(cb){
  const td = cb.closest('td');
  const row = cb.closest('tr');
  const section = cb.closest('section').dataset.section || cb.closest('section').className;
  const weekdayClass = (td.className.match(/col-(dom|seg|ter|qua|qui|sex|sab)/) || [])[0] || 'col-?';
  const rowLabel = row.querySelector('td:first-child')?.textContent.trim().replace(/\s+/g,'_').slice(0,50) || 'row';
  const weekStart = new Date(currentWeek.start).toISOString().slice(0,10);
  return `${weekStart}|${section}|${rowLabel}|${weekdayClass}`;
}
function restoreCheckboxes(){
  document.querySelectorAll('td.col input[type=checkbox]').forEach(cb => {
    const key = buildKeyForCheckbox(cb);
    cb.dataset.key = key;
    if (state.checks[key] === true){ cb.checked = true; }
    cb.addEventListener('change', () => {
      state.checks[cb.dataset.key] = cb.checked;
      saveState(state);
      updateSummary(); updateChart();
    });
  });
}
restoreCheckboxes();

// ===== Summary & Chart =====
function countForDay(dateObj){
  const wIdx = dateObj.getDay();
  const cls = classMap[wIdx];
  let total = 0, done = 0;
  document.querySelectorAll('tbody tr').forEach(tr => {
    const td = tr.querySelector('td.'+cls);
    if (!td) return;
    const cb = td.querySelector('input[type=checkbox]');
    if (cb){ total += 1; if (cb.checked) done += 1; }
  });
  return {total, done};
}
function updateSummary(){
  const {total, done} = countForDay(selectedDate);
  const pct = total ? Math.round(done*100/total) : 0;
  document.getElementById('doneCount').textContent = done;
  document.getElementById('totalCount').textContent = total;
  document.getElementById('pct').textContent = pct + '%';
  const fill = document.getElementById('barFill');
  fill.style.width = pct + '%';
  fill.className = pct>=85 ? 'g' : (pct>=60 ? 'y' : 'r');
}
function updateChart(){
  const weekStart = new Date(currentWeek.start);
  const chart = document.getElementById('chart');
  chart.innerHTML = '';
  for(let i=0;i<7;i++){
    const d = new Date(weekStart.getTime() + i*msPerDay);
    const {total, done} = countForDay(d);
    const pct = total ? Math.round(done*100/total) : 0;
    const col = document.createElement('div'); col.className = 'col';
    const bar = document.createElement('div'); bar.style.height = Math.max(3, Math.floor(0.8*pct)) + 'px';
    col.title = `${['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'][i]}: ${pct}% (${done}/${total})`;
    col.appendChild(bar); chart.appendChild(col);
  }
}
updateSummary(); updateChart(); applyWeekHeaders(); refreshHeader();
document.querySelector(`.mode-btn[data-mode="${mode}"]`)?.classList.add('active');
if (mode==='dia') { document.getElementById('dayCarousel').classList.remove('hidden'); showOnlyDay(selectedDate); }

// ===== Reset =====
document.getElementById('resetBtn').addEventListener('click', ()=>{
  if (confirm('Deseja limpar todas as marca√ß√µes e a vis√£o atual?')){
    state.checks = {}; state.ui = {};
    saveState(state);
    document.querySelectorAll('td.col input[type=checkbox]').forEach(cb => cb.checked = false);
    mode = 'semana';
    selectedDate = new Date(Math.min(Math.max(new Date(), start), end));
    showAllDays(); applyWeekHeaders(); refreshHeader(); updateSummary(); updateChart();
  }
});

// ===== PWA install =====
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
}
let deferredPrompt;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'inline-block';
});
installBtn?.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installBtn.style.display = 'none';
});

// ===== Supabase Sync =====
const SUPABASE_URL = "https://srmavbuaarejrqlibyha.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNybWF2YnVhYXJlanJxbGlieWhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NzUzNjIsImV4cCI6MjA3NjQ1MTM2Mn0.LpKRrGABJWE3cgnQI5eShlYlKwyS_NUp1To7FPhJ1sQ";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const PROFILE_ID = "marcio";

function isoToday(){ const d = new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function collectState(){ return loadState(); }
function applyFullState(newState){ localStorage.setItem(STORE_KEY, JSON.stringify(newState)); location.reload(); }

async function syncUp(){
  const day = isoToday();
  const full = collectState();
  const { error } = await sb
    .from('daily_state')
    .upsert(
      { profile_id: PROFILE_ID, day, state: full, updated_at: new Date().toISOString() },
      { onConflict: 'profile_id,day' } // evita erro de chave duplicada
    );
  alert(error ? ('‚ùå Erro: ' + error.message) : ('‚úÖ Salvo na nuvem para ' + day));
}
async function syncDown(){
  const day = isoToday();
  const { data, error } = await sb
    .from('daily_state')
    .select('state')
    .eq('profile_id', PROFILE_ID)
    .eq('day', day)
    .maybeSingle();
  if (error) return alert('‚ùå Erro: ' + error.message);
  if (!data) return alert('‚ö†Ô∏è Nenhum dado encontrado para ' + day);
  applyFullState(data.state);
}
document.getElementById('syncUpBtn').addEventListener('click', syncUp);
document.getElementById('syncDownBtn').addEventListener('click', syncDown);
</script>
</body>
</html>

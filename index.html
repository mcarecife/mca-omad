<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MCA-OMAD – Guia Diário (Fase III) · PWA v1.6</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f3b66">
<style>
  :root{
    --bg:#ffffff;--text:#111418;--muted:#6b7280;--card:#f7f8fa;--line:#e5e7eb;
    --blue:#CFE4F7;--green:#E5F4E3;--peach:#FFEFD6;--steel:#E8ECF2;--lilac:#F1ECF9;--gold:#FFF5CC;
    --accent:#0f3b66;--off:#f2f3f5;--highlight:#e0f2fe;--good:#16a34a;--warn:#d97706;--bad:#dc2626;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 12px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;z-index:10}
  h1{font-size:18px;margin:0;color:var(--accent)}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{font-size:13px;padding:6px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;color:#0f3b66;cursor:pointer}
  .btn:hover{background:#f3f4f6}
  .chip{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #ccc;background:#f8fafc}
  .week-btn.active,.mode-btn.active{background:#0f3b66;color:#fff;border-color:#0f3b66}
  .wrap{padding:14px;max-width:980px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;margin:10px 0;overflow:hidden}
  .band{padding:8px 12px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
  .manha .band{background:var(--blue)}.omad .band{background:var(--green)}.pre .band{background:var(--peach)}.pos .band{background:var(--steel)}.noite .band{background:var(--lilac)}.avancado .band{background:var(--gold)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:6px;font-size:13px;text-align:center;border-bottom:1px solid #e5e7eb}
  td:first-child,th:first-child{text-align:left}
  input[type=checkbox]{width:18px;height:18px}
  .today{background:var(--highlight)!important}
  .off{background:var(--off);color:#999}
  .hidden{display:none!important}
  .carousel{display:flex;gap:6px;align-items:center}
  .bar{height:10px;background:#e5e7eb;width:220px;border-radius:999px;overflow:hidden}
  .bar>div{height:100%}
  .g{background:var(--good)}.y{background:var(--warn)}.r{background:var(--bad)}
</style>
</head>
<body>
<header>
  <div>
    <h1>MCA-OMAD – Guia Diário (Fase III) · PWA v1.6</h1>
    <p><span id="dateLabel">—</span> · <span id="modeLabel">Semana</span></p>
  </div>
  <div class="toolbar">
    <span class="chip" id="todayChip">Hoje: —</span>
    <button class="btn mode-btn" data-mode="semana">Visão: Semana</button>
    <button class="btn mode-btn" data-mode="dia">Visão: Dia</button>
    <button class="btn week-btn" data-week="1">Semana 1</button>
    <button class="btn week-btn" data-week="2">Semana 2</button>
    <button class="btn week-btn" data-week="3">Semana 3</button>
    <button class="btn" id="resetBtn">♻ Resetar</button>
    <button class="btn" id="syncUpBtn">Sync ↑</button>
    <button class="btn" id="syncDownBtn">Sync ↓</button>
  </div>
</header>

<div class="wrap">
  <section class="card manha">
    <div class="band">🌅 Manhã</div>
    <div class="inner">
      <table><tr><td>GH</td><td class="col-dom"><input type="checkbox"></td><td class="col-ter"><input type="checkbox"></td></tr></table>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL="https://srmavbuaarejrqlibyha.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNybWF2YnVhYXJlanJxbGlieWhhIiwicm9zZSI6ImFub24iLCJpYXQiOjE3NjA4NzUzNjIsImV4cCI6MjA3NjQ1MTM2Mn0.LpKRrGABJWE3cgnQI5eShlYlKwyS_NUp1To7FPhJ1sQ";
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const PROFILE_ID="marcio";

// ===== Estado local =====
const STORE_KEY="mca_omad_v16";
function load(){try{return JSON.parse(localStorage.getItem(STORE_KEY))||{};}catch{return{};}}
function save(obj){localStorage.setItem(STORE_KEY,JSON.stringify(obj));}
let state=load(); if(!state.checks)state.checks={};

// ===== Checkboxes =====
document.querySelectorAll("input[type=checkbox]").forEach(cb=>{
  const key=cb.closest("td").className||Math.random();
  cb.dataset.key=key;
  cb.checked=!!state.checks[key];
  cb.addEventListener("change",()=>{
    state.checks[key]=cb.checked;
    save(state);
    syncUpDebounced();
  });
});

// ===== Sync =====
function isoToday(){const d=new Date();d.setHours(0,0,0,0);return d.toISOString().slice(0,10);}
async function syncUp(){
  const day=isoToday();
  const {error}=await sb.from("daily_state").upsert({profile_id:PROFILE_ID,day,state,updated_at:new Date().toISOString()});
  alert(error?"❌ Falha: "+error.message:"✅ Salvo na nuvem");
}
async function syncDown(){
  const day=isoToday();
  const {data,error}=await sb.from("daily_state").select("state").eq("profile_id",PROFILE_ID).eq("day",day).maybeSingle();
  if(error)return alert("❌ Erro: "+error.message);
  if(!data)return alert("⚠️ Nenhum dado encontrado");
  Object.entries(data.state.checks||{}).forEach(([k,v])=>{
    state.checks[k]=v;
    const cb=document.querySelector(`input[data-key='${k}']`);
    if(cb)cb.checked=v;
  });
  save(state);
  alert("⬇️ Estado baixado com sucesso");
}
document.getElementById("syncUpBtn").onclick=syncUp;
document.getElementById("syncDownBtn").onclick=syncDown;

// Auto-sync
let timer=null;
function syncUpDebounced(){clearTimeout(timer);timer=setTimeout(syncUp,800);}

// ===== Reset =====
document.getElementById("resetBtn").onclick=()=>{
  if(confirm("Limpar todas as marcações?")){
    state.checks={}; save(state);
    document.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);
  }
};

// ===== Modo Semana/Dia =====
let mode="semana";
function setMode(m){mode=m;document.getElementById("modeLabel").textContent=(m==="dia"?"Dia":"Semana");}
document.querySelectorAll(".mode-btn").forEach(btn=>btn.onclick=()=>setMode(btn.dataset.mode));
setMode(mode);

// ===== Auto-download on open =====
(async()=>{
  const day=isoToday();
  const {data}=await sb.from("daily_state").select("state").eq("profile_id",PROFILE_ID).eq("day",day).maybeSingle();
  if(data&&data.state){Object.assign(state,data.state);save(state);}
})();
</script>
</body>
</html>
